trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

parameters:
- name: stage
  default: "preprod"

stages:
  - stage: preprod
    condition: eq('${{ parameters.stage }}', 'preprod')
    jobs:
      - job: "Build"
        steps:
        - task: NodeTool@0
          inputs:
            versionSpec: '12.x'
        - script: |
            npm i && npm run build
          displayName: 'NPM install and build'
        - script: |
            ./create-keys.sh
            sleep 10
          displayName: 'Create SSH keys for JWTs'
        - script: |
            npm run docker:deps
            sleep 10
          displayName: 'Spin up SQL Server'
        - script: |
            npm t
          displayName: 'Run tests'
